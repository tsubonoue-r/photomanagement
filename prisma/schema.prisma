// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// NextAuth.js Required Models
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// Enums
// ============================================

enum Role {
  ADMIN
  MANAGER
  MEMBER
  VIEWER
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum AlbumStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// ============================================
// User Management Models
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  password      String?
  image         String?
  role          Role      @default(MEMBER)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  accounts       Account[]
  sessions       Session[]
  uploadedPhotos Photo[]   @relation("UploadedPhotos")
  createdAlbums  Album[]   @relation("CreatedAlbums")

  @@index([email])
  @@index([role])
  @@map("users")
}

// ============================================
// Project Management Models
// ============================================

model Project {
  id          String        @id @default(cuid())
  name        String
  code        String?       @unique // Project code (e.g., "PRJ-2024-001")
  description String?       @db.Text
  status      ProjectStatus @default(ACTIVE)
  clientName  String?       @map("client_name")
  location    String?
  startDate   DateTime?     @map("start_date")
  endDate     DateTime?     @map("end_date")
  metadata    Json? // Additional project metadata
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  photos     Photo[]
  categories Category[]
  albums     Album[]

  @@index([status])
  @@index([name])
  @@index([code])
  @@index([createdAt])
  @@map("projects")
}

// ============================================
// Category Management Models (Construction Photo Categories)
// ============================================

model Category {
  id          String   @id @default(cuid())
  name        String
  code        String? // Category code (e.g., "A-01", "B-02")
  description String?  @db.Text
  level       Int      @default(0) // Hierarchy level: 0=root, 1=child, etc.
  parentId    String?  @map("parent_id")
  projectId   String?  @map("project_id")
  isStandard  Boolean  @default(false) @map("is_standard") // Standard category template
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")
  project  Project?   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  photos   Photo[]

  @@unique([projectId, code]) // Unique code within project
  @@index([parentId])
  @@index([projectId])
  @@index([level])
  @@index([isStandard])
  @@index([sortOrder])
  @@map("categories")
}

// ============================================
// Photo Management Models
// ============================================

model Photo {
  id           String    @id @default(cuid())
  title        String
  description  String?   @db.Text
  url          String // Original image URL
  thumbnailUrl String?   @map("thumbnail_url")
  mediumUrl    String?   @map("medium_url") // Medium-sized image for display
  filename     String
  originalName String?   @map("original_name") // Original filename from upload
  mimeType     String    @map("mime_type")
  fileSize     Int       @map("file_size") // Size in bytes
  width        Int?
  height       Int?
  location     String? // Location description
  takenAt      DateTime? @map("taken_at")
  latitude     Float?
  longitude    Float?
  exifData     Json?     @map("exif_data") // EXIF metadata
  projectId    String?   @map("project_id")
  categoryId   String?   @map("category_id")
  uploadedBy   String    @map("uploaded_by")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  project    Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  category   Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  uploader   User         @relation("UploadedPhotos", fields: [uploadedBy], references: [id])
  albumItems AlbumPhoto[]
  blackboard Blackboard?

  @@index([projectId])
  @@index([categoryId])
  @@index([uploadedBy])
  @@index([takenAt])
  @@index([createdAt])
  @@index([projectId, categoryId])
  @@index([projectId, takenAt])
  @@map("photos")
}

// ============================================
// Blackboard Models (Construction Site Blackboard)
// ============================================

model Blackboard {
  id               String    @id @default(cuid())
  photoId          String    @unique @map("photo_id")
  constructionName String?   @map("construction_name") // Project/construction name
  contractor       String? // Contractor name
  workType         String?   @map("work_type") // Type of work
  workLocation     String?   @map("work_location") // Specific location
  workDetail       String?   @map("work_detail") @db.Text // Work details
  measurementData  Json?     @map("measurement_data") // Measurements (length, width, depth, etc.)
  date             DateTime? // Date shown on blackboard
  weather          String? // Weather condition
  personnel        String? // Workers present
  remarks          String?   @db.Text // Additional remarks
  templateType     String?   @map("template_type") // Blackboard template type
  rawData          Json?     @map("raw_data") // Raw OCR/parsed data
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  photo Photo @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([workType])
  @@index([contractor])
  @@map("blackboards")
}

// ============================================
// Album Management Models
// ============================================

model Album {
  id             String      @id @default(cuid())
  title          String
  name           String // Display name
  description    String?     @db.Text
  projectId      String?     @map("project_id")
  coverPhotoId   String?     @map("cover_photo_id")
  status         AlbumStatus @default(DRAFT)
  exportOptions  Json?       @map("export_options") // PDF/print export settings
  cover          Json? // Cover page design settings
  pageLayout     Json?       @map("page_layout") // Page layout settings
  createdBy      String      @map("created_by")
  lastExportedAt DateTime?   @map("last_exported_at")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  project Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  creator User         @relation("CreatedAlbums", fields: [createdBy], references: [id])
  photos  AlbumPhoto[]

  @@index([projectId])
  @@index([createdBy])
  @@index([status])
  @@index([createdAt])
  @@map("albums")
}

model AlbumPhoto {
  id          String   @id @default(cuid())
  albumId     String   @map("album_id")
  photoId     String   @map("photo_id")
  pageNumber  Int?     @map("page_number") // Page number in album
  sortOrder   Int      @default(0) @map("sort_order")
  customTitle String?  @map("custom_title")
  caption     String?  @db.Text // Photo caption in album
  layout      Json? // Individual photo layout settings
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  album Album @relation(fields: [albumId], references: [id], onDelete: Cascade)
  photo Photo @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@unique([albumId, photoId])
  @@index([albumId])
  @@index([photoId])
  @@index([albumId, sortOrder])
  @@index([albumId, pageNumber])
  @@map("album_photos")
}
